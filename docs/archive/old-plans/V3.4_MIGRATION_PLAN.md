# Director Agent v3.4 Migration Plan

**Project**: Deckster Frontend
**Migration**: Director v2.0 ‚Üí v3.4
**Date Created**: January 2025
**Status**: Ready for Implementation

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Breaking Changes Analysis](#breaking-changes-analysis)
3. [File-by-File Implementation Guide](#file-by-file-implementation-guide)
4. [Implementation Checklist](#implementation-checklist)
5. [Manual Testing Plan](#manual-testing-plan)
6. [Rollback Plan](#rollback-plan)
7. [Post-Migration Validation](#post-migration-validation)
8. [Timeline & Dependencies](#timeline--dependencies)
9. [Appendix](#appendix)

---

## Executive Summary

### Overview

This document provides a complete migration plan for upgrading the Deckster frontend from Director Agent v2.0 to v3.4. The migration involves significant breaking changes to the WebSocket message protocol and type definitions.

### Key Changes

- **WebSocket URL**: `wss://directorv20-production.up.railway.app` ‚Üí `wss://directorv33-production.up.railway.app`
- **Message Structure**: Simplified from `{message_id, session_id, timestamp, type, payload}` to `{type, data}`
- **New Features**: Slide structure preview, detailed progress tracking, dedicated error handling
- **Removed Features**: State change messages, message IDs, server timestamps

### Timeline Estimate

| Phase | Duration | Description |
|-------|----------|-------------|
| Preparation | 30 min | Review plan, backup code |
| Type Updates | 1-2 hours | Update all TypeScript interfaces |
| UI Updates | 1-2 hours | Update component rendering logic |
| Testing | 1-2 hours | Manual testing and validation |
| **Total** | **3-6 hours** | **Complete migration** |

### Risk Assessment

| Risk Level | Probability | Mitigation |
|------------|-------------|------------|
| **Medium** | Medium | Full migration with no backward compatibility. Test thoroughly before deployment. |

### Success Criteria

- ‚úÖ WebSocket connects to v3.4 endpoint successfully
- ‚úÖ All message types render correctly in UI
- ‚úÖ Complete presentation generation flow works end-to-end
- ‚úÖ No console errors or TypeScript errors
- ‚úÖ Presentation URL loads correctly in iframe

---

## Breaking Changes Analysis

### 1. WebSocket Connection URL

**Change**: Production WebSocket URL updated

**Before (v2.0):**
```typescript
wss://directorv20-production.up.railway.app/ws
```

**After (v3.4):**
```typescript
wss://directorv33-production.up.railway.app/ws
```

**Impact**:
- Must update hardcoded URL in `hooks/use-deckster-websocket-v2.ts`
- Connection will fail if not updated
- No data migration needed (fresh sessions)

**Files Affected**:
- `hooks/use-deckster-websocket-v2.ts` (line 99)

---

### 2. Message Structure Simplification

**Change**: Message envelope simplified, metadata removed

**Before (v2.0):**
```typescript
{
  message_id: "msg_123abc",
  session_id: "sess_456def",
  timestamp: "2025-01-05T10:30:00",
  type: "chat_message",
  payload: {
    text: "Hello!"
  }
}
```

**After (v3.4):**
```typescript
{
  type: "chat_message",
  data: {
    text: "Hello!"
  }
}
```

**Impact**:
- All type interfaces must be updated
- `payload` field renamed to `data` everywhere
- Timestamp sorting logic needs client-side timestamps
- Message IDs must be generated client-side if needed for React keys

**Files Affected**:
- `hooks/use-deckster-websocket-v2.ts` (all interface definitions)
- `app/builder/page.tsx` (message rendering)

---

### 3. Message Type Changes

#### 3.1 `chat_message` Simplified

**Before (v2.0):**
```typescript
{
  type: "chat_message",
  payload: {
    text: string;
    sub_title?: string;      // ‚ùå REMOVED
    list_items?: string[];   // ‚ùå REMOVED
    format?: 'markdown' | 'plain';
  }
}
```

**After (v3.4):**
```typescript
{
  type: "chat_message",
  data: {
    text: string;
    format?: 'markdown' | 'text';  // Changed from 'plain'
  }
}
```

**Impact**:
- Remove UI rendering for `sub_title` and `list_items`
- Update format value from `'plain'` to `'text'`

---

#### 3.2 `action_request` Simplified

**Before (v2.0):**
```typescript
{
  type: "action_request",
  payload: {
    prompt_text: string;
    actions: Array<{
      label: string;
      value: string;
      primary: boolean;
      requires_input: boolean;  // ‚ùå REMOVED
    }>;
  }
}
```

**After (v3.4):**
```typescript
{
  type: "action_request",
  data: {
    prompt_text: string;
    actions: Array<{
      label: string;
      value: string;
      primary: boolean;
    }>;
  }
}
```

**Impact**:
- Remove `requires_input` handling logic
- All actions now handled uniformly

---

#### 3.3 `status_update` ‚Üí `progress_update` (MAJOR CHANGE)

**Before (v2.0) - `status_update`:**
```typescript
{
  type: "status_update",
  payload: {
    status: 'idle' | 'thinking' | 'generating' | 'complete' | 'error';
    text: string;
    progress?: number;
    estimated_time?: number;
  }
}
```

**After (v3.4) - `progress_update`:**
```typescript
{
  type: "progress_update",
  data: {
    stage: 'content_generation' | string;
    message: string;
    current_slide: number;
    total_slides: number;
    percentage: number;  // Now mandatory
  }
}
```

**Impact**:
- Completely new interface - not compatible
- More granular progress tracking with slide numbers
- `status` field removed - status derived from other fields
- `text` renamed to `message`
- `progress` renamed to `percentage` and is now required

---

#### 3.4 `presentation_url` Enhanced

**Before (v2.0):**
```typescript
{
  type: "presentation_url",
  payload: {
    url: string;
    presentation_id: string;  // ‚ùå REMOVED
    slide_count: number;
    message: string;
  }
}
```

**After (v3.4):**
```typescript
{
  type: "presentation_url",
  data: {
    url: string;
    slide_count: number;
    content_generated: boolean;     // ‚úÖ NEW
    successful_slides: number;      // ‚úÖ NEW
    failed_slides: number;          // ‚úÖ NEW
    message: string;
  }
}
```

**Impact**:
- Can now show success/failure statistics
- `presentation_id` removed - not needed by frontend
- Better user feedback on partial failures

---

#### 3.5 NEW: `slide_update` Message Type

**New in v3.4:**
```typescript
{
  type: "slide_update",
  data: {
    operation: "full_update";
    metadata: {
      title: string;
      total_slides: number;
      theme: string;
      duration_minutes: number;
    };
    slides: Array<{
      slide_number: number;
      title: string;
      classification: string;
      layout_id: string;
      narrative: string;
      topics: string[];
      variant_id?: string;
    }>;
  }
}
```

**Purpose**:
- Shows presentation structure during Stages 3-5
- Allows users to preview outline before content generation
- Can be displayed in chat or stored for later use

**Impact**:
- Need to add new interface
- Need to add UI rendering for slide structure preview
- Store in state for potential use

---

#### 3.6 NEW: `error` Message Type

**New in v3.4:**
```typescript
{
  type: "error",
  data: {
    error: string;
    details: string;
    recoverable: boolean;
  }
}
```

**Purpose**:
- Dedicated error handling
- Indicates if error is recoverable
- Provides detailed error information

**Impact**:
- Need to add new interface
- Need to add error message UI rendering
- Can show retry options for recoverable errors

---

#### 3.7 REMOVED: `state_change` Message Type

**Removed from v3.4:**

The `state_change` message type no longer exists. State transitions are now implicit based on the message flow.

**Impact**:
- Remove `StateChange` interface
- Remove from `DirectorMessage` union type
- Remove any UI handling for state changes

---

### 4. State Management Changes

**Before (v2.0):**
```typescript
interface State {
  currentStatus: StatusUpdate['payload'] | null;
  presentationId: string | null;
  // ... other fields
}
```

**After (v3.4):**
```typescript
interface State {
  currentProgress: ProgressUpdate['data'] | null;  // Renamed
  slideStructure: SlideUpdate['data'] | null;      // New
  // presentationId removed
  // ... other fields
}
```

**Impact**:
- Update state interface
- Update all references to `currentStatus` ‚Üí `currentProgress`
- Add `slideStructure` to track presentation outline
- Remove `presentationId` field

---

## File-by-File Implementation Guide

### File 1: `hooks/use-deckster-websocket-v2.ts`

This file contains all TypeScript type definitions and WebSocket logic.

---

#### Change 1.1: Update WebSocket URL (Line 99)

**Location**: Line 99

**Before:**
```typescript
const DEFAULT_WS_URL = 'wss://directorv20-production.up.railway.app/ws';
```

**After:**
```typescript
const DEFAULT_WS_URL = 'wss://directorv33-production.up.railway.app/ws';
```

**Why**: Connect to the new v3.4 Director endpoint

---

#### Change 1.2: Update BaseMessage Interface (Lines 6-12)

**Location**: Lines 6-12

**Before:**
```typescript
export interface BaseMessage {
  message_id: string;
  session_id: string;
  timestamp: string;
  type: 'chat_message' | 'action_request' | 'status_update' | 'presentation_url' | 'state_change';
  payload: any;
}
```

**After:**
```typescript
export interface BaseMessage {
  type: 'chat_message' | 'action_request' | 'slide_update' | 'presentation_url' | 'progress_update' | 'error';
  data: any;
}
```

**Why**: v3.4 simplified message structure, removed metadata fields, renamed payload to data

---

#### Change 1.3: Update ChatMessage Interface (Lines 14-22)

**Location**: Lines 14-22

**Before:**
```typescript
export interface ChatMessage extends BaseMessage {
  type: 'chat_message';
  payload: {
    text: string;
    sub_title?: string;
    list_items?: string[];
    format?: 'markdown' | 'plain';
  };
}
```

**After:**
```typescript
export interface ChatMessage {
  type: 'chat_message';
  data: {
    text: string;
    format?: 'markdown' | 'text';
  };
}
```

**Why**: Removed sub_title and list_items, changed payload to data, updated format value

---

#### Change 1.4: Update ActionRequest Interface (Lines 24-35)

**Location**: Lines 24-35

**Before:**
```typescript
export interface ActionRequest extends BaseMessage {
  type: 'action_request';
  payload: {
    prompt_text: string;
    actions: Array<{
      label: string;
      value: string;
      primary: boolean;
      requires_input: boolean;
    }>;
  };
}
```

**After:**
```typescript
export interface ActionRequest {
  type: 'action_request';
  data: {
    prompt_text: string;
    actions: Array<{
      label: string;
      value: string;
      primary: boolean;
    }>;
  };
}
```

**Why**: Removed requires_input field, changed payload to data

---

#### Change 1.5: Replace StatusUpdate with ProgressUpdate (Lines 37-45)

**Location**: Lines 37-45

**Before:**
```typescript
export interface StatusUpdate extends BaseMessage {
  type: 'status_update';
  payload: {
    status: 'idle' | 'thinking' | 'generating' | 'complete' | 'error';
    text: string;
    progress?: number;
    estimated_time?: number;
  };
}
```

**After:**
```typescript
export interface ProgressUpdate {
  type: 'progress_update';
  data: {
    stage: 'content_generation' | string;
    message: string;
    current_slide: number;
    total_slides: number;
    percentage: number;
  };
}
```

**Why**: Completely redesigned progress tracking with slide-level granularity

---

#### Change 1.6: Update PresentationURL Interface (Lines 47-55)

**Location**: Lines 47-55

**Before:**
```typescript
export interface PresentationURL extends BaseMessage {
  type: 'presentation_url';
  payload: {
    url: string;
    presentation_id: string;
    slide_count: number;
    message: string;
  };
}
```

**After:**
```typescript
export interface PresentationURL {
  type: 'presentation_url';
  data: {
    url: string;
    slide_count: number;
    content_generated: boolean;
    successful_slides: number;
    failed_slides: number;
    message: string;
  };
}
```

**Why**: Added success/failure tracking, removed presentation_id, changed payload to data

---

#### Change 1.7: Add NEW SlideUpdate Interface (After line 55)

**Location**: Add new interface after PresentationURL

**Add:**
```typescript
export interface SlideUpdate {
  type: 'slide_update';
  data: {
    operation: 'full_update' | string;
    metadata: {
      title: string;
      total_slides: number;
      theme: string;
      duration_minutes: number;
    };
    slides: Array<{
      slide_number: number;
      title: string;
      classification: string;
      layout_id: string;
      narrative: string;
      topics: string[];
      variant_id?: string;
    }>;
  };
}
```

**Why**: New message type for showing presentation structure preview

---

#### Change 1.8: Add NEW ErrorMessage Interface (After SlideUpdate)

**Location**: Add new interface after SlideUpdate

**Add:**
```typescript
export interface ErrorMessage {
  type: 'error';
  data: {
    error: string;
    details: string;
    recoverable: boolean;
  };
}
```

**Why**: New dedicated error message type

---

#### Change 1.9: Remove StateChange Interface (Lines 57-61)

**Location**: Lines 57-61

**Before:**
```typescript
export interface StateChange extends BaseMessage {
  type: 'state_change';
  new_state: string;
  previous_state: string;
}
```

**After:**
```typescript
// Remove this interface entirely
```

**Why**: State change messages no longer exist in v3.4

---

#### Change 1.10: Update DirectorMessage Union Type (Line 63)

**Location**: Line 63

**Before:**
```typescript
export type DirectorMessage = ChatMessage | ActionRequest | StatusUpdate | PresentationURL | StateChange;
```

**After:**
```typescript
export type DirectorMessage = ChatMessage | ActionRequest | SlideUpdate | PresentationURL | ProgressUpdate | ErrorMessage;
```

**Why**: Updated to include new types and remove old ones

---

#### Change 1.11: Update UseDecksterWebSocketV2State Interface (Lines 74-86)

**Location**: Lines 74-86

**Before:**
```typescript
export interface UseDecksterWebSocketV2State {
  connected: boolean;
  connecting: boolean;
  connectionState: 'disconnected' | 'connecting' | 'connected' | 'error';
  sessionId: string;
  userId: string;
  error: Error | null;
  messages: DirectorMessage[];
  presentationUrl: string | null;
  presentationId: string | null;
  slideCount: number | null;
  currentStatus: StatusUpdate['payload'] | null;
}
```

**After:**
```typescript
export interface UseDecksterWebSocketV2State {
  connected: boolean;
  connecting: boolean;
  connectionState: 'disconnected' | 'connecting' | 'connected' | 'error';
  sessionId: string;
  userId: string;
  error: Error | null;
  messages: DirectorMessage[];
  presentationUrl: string | null;
  slideCount: number | null;
  currentProgress: ProgressUpdate['data'] | null;
  slideStructure: SlideUpdate['data'] | null;
}
```

**Why**: Renamed currentStatus to currentProgress, added slideStructure, removed presentationId

---

#### Change 1.12: Update Initial State (Lines 117-129)

**Location**: Lines 117-129

**Before:**
```typescript
const [state, setState] = useState<UseDecksterWebSocketV2State>({
  connected: false,
  connecting: false,
  connectionState: 'disconnected',
  sessionId: sessionIdRef.current,
  userId: userIdRef.current,
  error: null,
  messages: [],
  presentationUrl: null,
  presentationId: null,
  slideCount: null,
  currentStatus: null,
});
```

**After:**
```typescript
const [state, setState] = useState<UseDecksterWebSocketV2State>({
  connected: false,
  connecting: false,
  connectionState: 'disconnected',
  sessionId: sessionIdRef.current,
  userId: userIdRef.current,
  error: null,
  messages: [],
  presentationUrl: null,
  slideCount: null,
  currentProgress: null,
  slideStructure: null,
});
```

**Why**: Match updated state interface

---

#### Change 1.13: Add Client-Side Timestamp to Messages (Lines 184-223)

**Location**: Lines 184-223 (ws.onmessage handler)

**Before:**
```typescript
ws.onmessage = (event) => {
  try {
    const message: DirectorMessage = JSON.parse(event.data);
    console.log('üì® Received message:', message.type, message);

    setState(prev => {
      const newState = {
        ...prev,
        messages: [...prev.messages, message],
      };
      // ... rest of switch statement
```

**After:**
```typescript
ws.onmessage = (event) => {
  try {
    const message: DirectorMessage = JSON.parse(event.data);

    // Add client-side timestamp for message ordering
    const messageWithTimestamp = {
      ...message,
      clientTimestamp: Date.now()
    } as DirectorMessage & { clientTimestamp: number };

    console.log('üì® Received message:', message.type, message);

    setState(prev => {
      const newState = {
        ...prev,
        messages: [...prev.messages, messageWithTimestamp],
      };
      // ... rest of switch statement
```

**Why**: v3.4 doesn't include timestamps, so add them client-side for message ordering

---

#### Change 1.14: Update Message Handler Switch Statement (Lines 196-210)

**Location**: Lines 196-210

**Before:**
```typescript
// Handle specific message types
switch (message.type) {
  case 'status_update':
    newState.currentStatus = message.payload;
    break;

  case 'presentation_url':
    newState.presentationUrl = message.payload.url;
    newState.presentationId = message.payload.presentation_id;
    newState.slideCount = message.payload.slide_count;

    // Trigger callback
    if (options.onPresentationReady) {
      options.onPresentationReady(message.payload.url);
    }
    break;
}
```

**After:**
```typescript
// Handle specific message types
switch (message.type) {
  case 'progress_update':
    newState.currentProgress = message.data;
    break;

  case 'presentation_url':
    newState.presentationUrl = message.data.url;
    newState.slideCount = message.data.slide_count;

    // Trigger callback
    if (options.onPresentationReady) {
      options.onPresentationReady(message.data.url);
    }
    break;

  case 'slide_update':
    newState.slideStructure = message.data;
    break;

  case 'error':
    const err = new Error(message.data.error);
    newState.error = err;

    if (options.onError) {
      options.onError(err);
    }
    break;
}
```

**Why**: Handle new message types, update field names from payload to data

---

#### Change 1.15: Update clearMessages Function (Lines 335-344)

**Location**: Lines 335-344

**Before:**
```typescript
const clearMessages = useCallback(() => {
  setState(prev => ({
    ...prev,
    messages: [],
    presentationUrl: null,
    presentationId: null,
    slideCount: null,
    currentStatus: null,
  }));
}, []);
```

**After:**
```typescript
const clearMessages = useCallback(() => {
  setState(prev => ({
    ...prev,
    messages: [],
    presentationUrl: null,
    slideCount: null,
    currentProgress: null,
    slideStructure: null,
  }));
}, []);
```

**Why**: Match updated state interface

---

### File 2: `app/builder/page.tsx`

This file contains the UI rendering logic for the builder interface.

---

#### Change 2.1: Update Imports (Line 5)

**Location**: Line 5

**Before:**
```typescript
import { useDecksterWebSocketV2, type DirectorMessage, type ChatMessage as V2ChatMessage, type ActionRequest, type StatusUpdate, type PresentationURL } from "@/hooks/use-deckster-websocket-v2"
```

**After:**
```typescript
import { useDecksterWebSocketV2, type DirectorMessage, type ChatMessage as V2ChatMessage, type ActionRequest, type ProgressUpdate, type PresentationURL, type SlideUpdate, type ErrorMessage } from "@/hooks/use-deckster-websocket-v2"
```

**Why**: Import new types (ProgressUpdate, SlideUpdate, ErrorMessage) and remove old (StatusUpdate)

---

#### Change 2.2: Update Hook Destructuring (Lines 36-48)

**Location**: Lines 36-48

**Before:**
```typescript
const {
  connected,
  connecting,
  connectionState,
  error: wsError,
  messages,
  presentationUrl,
  slideCount,
  currentStatus,
  sendMessage,
  clearMessages,
  isReady
} = useDecksterWebSocketV2({
  autoConnect: true,
  reconnectOnError: false,
  maxReconnectAttempts: 0,
  reconnectDelay: 5000
})
```

**After:**
```typescript
const {
  connected,
  connecting,
  connectionState,
  error: wsError,
  messages,
  presentationUrl,
  slideCount,
  currentProgress,
  slideStructure,
  sendMessage,
  clearMessages,
  isReady
} = useDecksterWebSocketV2({
  autoConnect: true,
  reconnectOnError: false,
  maxReconnectAttempts: 0,
  reconnectDelay: 5000
})
```

**Why**: Use new state fields (currentProgress, slideStructure) instead of old (currentStatus)

---

#### Change 2.3: Update Status Bar Rendering (Lines 177-187)

**Location**: Lines 177-187

**Before:**
```typescript
{currentStatus && (
  <div className="p-4 border-b bg-gray-50">
    <div className="flex items-center gap-2">
      <Loader2 className="h-4 w-4 animate-spin text-blue-500" />
      <span className="text-sm">{currentStatus.text}</span>
    </div>
    {currentStatus.progress !== undefined && (
      <Progress value={currentStatus.progress} className="mt-2" />
    )}
  </div>
)}
```

**After:**
```typescript
{currentProgress && (
  <div className="p-4 border-b bg-gray-50">
    <div className="flex items-center gap-2">
      <Loader2 className="h-4 w-4 animate-spin text-blue-500" />
      <span className="text-sm">{currentProgress.message}</span>
    </div>
    <Progress value={currentProgress.percentage} className="mt-2" />
    {currentProgress.current_slide && currentProgress.total_slides && (
      <p className="text-xs text-gray-600 mt-1">
        Generating slide {currentProgress.current_slide} of {currentProgress.total_slides}
      </p>
    )}
  </div>
)}
```

**Why**: Use new progress structure with message, percentage, and slide numbers

---

#### Change 2.4: Fix Message Sorting (Lines 193-209)

**Location**: Lines 193-209

**Before:**
```typescript
const sorted = combined.sort((a, b) => {
  // User messages have numeric timestamps (milliseconds), bot messages have ISO string timestamps
  const timeA = a.messageType === 'user'
    ? a.timestamp
    : new Date(a.timestamp + 'Z').getTime() // Add 'Z' to treat as UTC
  const timeB = b.messageType === 'user'
    ? b.timestamp
    : new Date(b.timestamp + 'Z').getTime() // Add 'Z' to treat as UTC

  return timeA - timeB
});
```

**After:**
```typescript
const sorted = combined.sort((a, b) => {
  // User messages have numeric timestamps
  const timeA = a.messageType === 'user'
    ? a.timestamp
    : (a as any).clientTimestamp || 0; // Use client-side timestamp added in hook

  const timeB = b.messageType === 'user'
    ? b.timestamp
    : (b as any).clientTimestamp || 0;

  return timeA - timeB;
});
```

**Why**: v3.4 messages don't have server timestamps, use client-side timestamps instead

---

#### Change 2.5: Update chat_message Rendering (Lines 234-258)

**Location**: Lines 234-258

**Before:**
```typescript
if (msg.type === 'chat_message') {
  const chatMsg = msg as V2ChatMessage
  return (
    <div key={msg.message_id} className="flex gap-2">
      <div className="flex-shrink-0">
        <Bot className="h-6 w-6 text-blue-600" />
      </div>
      <div className="flex-1">
        <div className="bg-gray-100 rounded-lg p-3">
          <p className="text-sm whitespace-pre-wrap">{chatMsg.payload.text}</p>
          {chatMsg.payload.sub_title && (
            <p className="text-xs text-gray-600 mt-2">{chatMsg.payload.sub_title}</p>
          )}
          {chatMsg.payload.list_items && chatMsg.payload.list_items.length > 0 && (
            <ul className="mt-2 space-y-1">
              {chatMsg.payload.list_items.map((item, i) => (
                <li key={i} className="text-sm text-gray-700 flex items-start gap-2">
                  <span className="text-blue-600">‚Ä¢</span>
                  <span>{item}</span>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>
    </div>
  )
}
```

**After:**
```typescript
if (msg.type === 'chat_message') {
  const chatMsg = msg as V2ChatMessage
  return (
    <div key={(msg as any).clientTimestamp || Math.random()} className="flex gap-2">
      <div className="flex-shrink-0">
        <Bot className="h-6 w-6 text-blue-600" />
      </div>
      <div className="flex-1">
        <div className="bg-gray-100 rounded-lg p-3">
          <p className="text-sm whitespace-pre-wrap">{chatMsg.data.text}</p>
        </div>
      </div>
    </div>
  )
}
```

**Why**: Changed payload to data, removed sub_title and list_items rendering, use clientTimestamp for key

---

#### Change 2.6: Update action_request Rendering (Lines 260-287)

**Location**: Lines 260-287

**Before:**
```typescript
} else if (msg.type === 'action_request') {
  const actionMsg = msg as ActionRequest
  return (
    <div key={msg.message_id} className="space-y-2">
      <div className="flex gap-2">
        <div className="flex-shrink-0">
          <Bot className="h-6 w-6 text-blue-600" />
        </div>
        <div className="flex-1">
          <div className="bg-gray-100 rounded-lg p-3">
            <p className="text-sm font-medium">{actionMsg.payload.prompt_text}</p>
          </div>
        </div>
      </div>
      <div className="ml-8 flex flex-wrap gap-2">
        {actionMsg.payload.actions.map((action, i) => (
          <Button
            key={i}
            size="sm"
            variant={action.primary ? "default" : "outline"}
            onClick={() => handleActionClick(action)}
          >
            {action.label}
          </Button>
        ))}
      </div>
    </div>
  )
}
```

**After:**
```typescript
} else if (msg.type === 'action_request') {
  const actionMsg = msg as ActionRequest
  return (
    <div key={(msg as any).clientTimestamp || Math.random()} className="space-y-2">
      <div className="flex gap-2">
        <div className="flex-shrink-0">
          <Bot className="h-6 w-6 text-blue-600" />
        </div>
        <div className="flex-1">
          <div className="bg-gray-100 rounded-lg p-3">
            <p className="text-sm font-medium">{actionMsg.data.prompt_text}</p>
          </div>
        </div>
      </div>
      <div className="ml-8 flex flex-wrap gap-2">
        {actionMsg.data.actions.map((action, i) => (
          <Button
            key={i}
            size="sm"
            variant={action.primary ? "default" : "outline"}
            onClick={() => handleActionClick(action)}
          >
            {action.label}
          </Button>
        ))}
      </div>
    </div>
  )
}
```

**Why**: Changed payload to data, use clientTimestamp for key

---

#### Change 2.7: Update status_update to progress_update (Lines 288-298)

**Location**: Lines 288-298

**Before:**
```typescript
} else if (msg.type === 'status_update') {
  const statusMsg = msg as StatusUpdate
  return (
    <div key={msg.message_id} className="flex items-center gap-2 text-sm text-gray-600">
      <Loader2 className="h-4 w-4 animate-spin" />
      <span>{statusMsg.payload.text}</span>
      {statusMsg.payload.progress !== undefined && (
        <span className="text-xs">({statusMsg.payload.progress}%)</span>
      )}
    </div>
  )
}
```

**After:**
```typescript
} else if (msg.type === 'progress_update') {
  const progressMsg = msg as ProgressUpdate
  return (
    <div key={(msg as any).clientTimestamp || Math.random()} className="flex items-center gap-2 text-sm text-gray-600">
      <Loader2 className="h-4 w-4 animate-spin" />
      <span>{progressMsg.data.message}</span>
      <span className="text-xs">
        ({progressMsg.data.percentage}% - Slide {progressMsg.data.current_slide}/{progressMsg.data.total_slides})
      </span>
    </div>
  )
}
```

**Why**: Type renamed, changed to data, show more detailed progress with slide numbers

---

#### Change 2.8: Add slide_update Rendering (After progress_update)

**Location**: Add new conditional block after progress_update

**Add:**
```typescript
} else if (msg.type === 'slide_update') {
  const slideMsg = msg as SlideUpdate
  return (
    <div key={(msg as any).clientTimestamp || Math.random()} className="flex gap-2">
      <div className="flex-shrink-0">
        <Bot className="h-6 w-6 text-blue-600" />
      </div>
      <div className="flex-1">
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p className="text-sm font-medium text-blue-800">
            üìä Presentation Plan: {slideMsg.data.metadata.title}
          </p>
          <p className="text-xs text-blue-600 mt-1">
            {slideMsg.data.metadata.total_slides} slides ‚Ä¢ {slideMsg.data.metadata.duration_minutes} minutes ‚Ä¢ Theme: {slideMsg.data.metadata.theme}
          </p>
          <div className="mt-3 space-y-1 max-h-40 overflow-y-auto">
            {slideMsg.data.slides.map((slide, i) => (
              <div key={i} className="text-xs bg-white rounded p-2">
                <span className="font-medium text-gray-700">
                  {slide.slide_number}. {slide.title}
                </span>
                <span className="text-gray-500 ml-2">({slide.classification})</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  )
}
```

**Why**: New message type in v3.4 for showing presentation structure

---

#### Change 2.9: Update presentation_url Rendering (Lines 299-324)

**Location**: Lines 299-324

**Before:**
```typescript
} else if (msg.type === 'presentation_url') {
  const presMsg = msg as PresentationURL
  return (
    <div key={msg.message_id} className="flex gap-2">
      <div className="flex-shrink-0">
        <Bot className="h-6 w-6 text-blue-600" />
      </div>
      <div className="flex-1">
        <div className="bg-green-50 border border-green-200 rounded-lg p-3">
          <p className="text-sm font-medium text-green-800">{presMsg.payload.message}</p>
          <p className="text-xs text-green-600 mt-1">
            {presMsg.payload.slide_count} slides created
          </p>
          <Button
            size="sm"
            variant="outline"
            className="mt-2"
            onClick={() => window.open(presMsg.payload.url, '_blank')}
          >
            <ExternalLink className="h-3 w-3 mr-1" />
            Open in new tab
          </Button>
        </div>
      </div>
    </div>
  )
}
```

**After:**
```typescript
} else if (msg.type === 'presentation_url') {
  const presMsg = msg as PresentationURL
  const hasFailures = presMsg.data.failed_slides > 0;
  return (
    <div key={(msg as any).clientTimestamp || Math.random()} className="flex gap-2">
      <div className="flex-shrink-0">
        <Bot className="h-6 w-6 text-blue-600" />
      </div>
      <div className="flex-1">
        <div className={`border rounded-lg p-3 ${hasFailures ? 'bg-orange-50 border-orange-200' : 'bg-green-50 border-green-200'}`}>
          <p className={`text-sm font-medium ${hasFailures ? 'text-orange-800' : 'text-green-800'}`}>
            {hasFailures ? '‚ö†Ô∏è' : '‚úÖ'} {presMsg.data.message}
          </p>
          <p className={`text-xs mt-1 ${hasFailures ? 'text-orange-600' : 'text-green-600'}`}>
            {presMsg.data.successful_slides} of {presMsg.data.slide_count} slides generated successfully
          </p>
          {hasFailures && (
            <p className="text-xs text-orange-600 mt-1">
              {presMsg.data.failed_slides} slide(s) failed to generate
            </p>
          )}
          <Button
            size="sm"
            variant="outline"
            className="mt-2"
            onClick={() => window.open(presMsg.data.url, '_blank')}
          >
            <ExternalLink className="h-3 w-3 mr-1" />
            Open presentation
          </Button>
        </div>
      </div>
    </div>
  )
}
```

**Why**: Changed payload to data, show success/failure statistics, conditional styling

---

#### Change 2.10: Add error Message Rendering (After presentation_url)

**Location**: Add new conditional block after presentation_url

**Add:**
```typescript
} else if (msg.type === 'error') {
  const errorMsg = msg as ErrorMessage
  return (
    <div key={(msg as any).clientTimestamp || Math.random()} className="flex gap-2">
      <div className="flex-shrink-0">
        <Bot className="h-6 w-6 text-red-600" />
      </div>
      <div className="flex-1">
        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
          <p className="text-sm font-medium text-red-800">
            ‚ùå Error: {errorMsg.data.error}
          </p>
          {errorMsg.data.details && (
            <p className="text-xs text-red-600 mt-1">{errorMsg.data.details}</p>
          )}
          {errorMsg.data.recoverable && (
            <p className="text-xs text-gray-600 mt-2 italic">
              This error is recoverable. You can try again or modify your request.
            </p>
          )}
        </div>
      </div>
    </div>
  )
}
```

**Why**: New message type in v3.4 for dedicated error handling

---

## Implementation Checklist

### Pre-Migration

- [ ] **Backup Current Code**
  - [ ] Commit all current changes to git
  - [ ] Create backup branch: `git branch backup-pre-v3.4-migration`
  - [ ] Verify backup exists: `git branch --list`

- [ ] **Review Documentation**
  - [ ] Read this entire migration plan
  - [ ] Review v3.4 frontend integration guide
  - [ ] Understand all breaking changes

- [ ] **Setup Development Environment**
  - [ ] Ensure local development server is running
  - [ ] Browser DevTools open for debugging
  - [ ] Clear browser cache and localStorage

### Phase 1: Type Definitions Update

**File**: `hooks/use-deckster-websocket-v2.ts`

- [x] **1.1** Update WebSocket URL to v3.3 endpoint (Line 99)
- [x] **1.2** Update BaseMessage interface (Lines 6-12)
- [x] **1.3** Update ChatMessage interface (Lines 14-22)
- [x] **1.4** Update ActionRequest interface (Lines 24-35)
- [x] **1.5** Replace StatusUpdate with ProgressUpdate (Lines 37-45)
- [x] **1.6** Update PresentationURL interface (Lines 47-55)
- [x] **1.7** Add NEW SlideUpdate interface
- [x] **1.8** Add NEW ErrorMessage interface
- [x] **1.9** Remove StateChange interface (Lines 57-61)
- [x] **1.10** Update DirectorMessage union type (Line 63)
- [x] **1.11** Update UseDecksterWebSocketV2State interface (Lines 74-86)
- [ ] **1.12** Verify no TypeScript errors in file

### Phase 2: Hook Logic Update

**File**: `hooks/use-deckster-websocket-v2.ts`

- [x] **2.1** Update initial state object (Lines 117-129)
- [x] **2.2** Add client-side timestamp to messages (Lines 184-223)
- [x] **2.3** Update message handler switch: progress_update case
- [x] **2.4** Update message handler switch: presentation_url case
- [x] **2.5** Add message handler switch: slide_update case
- [x] **2.6** Add message handler switch: error case
- [x] **2.7** Update clearMessages function (Lines 335-344)
- [ ] **2.8** Verify no TypeScript errors in file
- [ ] **2.9** Test compile: `pnpm build` or `pnpm dev`

### Phase 3: UI Component Update

**File**: `app/builder/page.tsx`

- [x] **3.1** Update imports to include new types (Line 5)
- [x] **3.2** Update hook destructuring (Lines 36-48)
- [x] **3.3** Update status bar rendering (Lines 177-187)
- [x] **3.4** Fix message sorting logic (Lines 193-209)
- [x] **3.5** Update chat_message rendering (Lines 234-258)
- [x] **3.6** Update action_request rendering (Lines 260-287)
- [x] **3.7** Rename and update status_update to progress_update (Lines 288-298)
- [x] **3.8** Add slide_update rendering (new block)
- [x] **3.9** Update presentation_url rendering (Lines 299-324)
- [x] **3.10** Add error message rendering (new block)
- [ ] **3.11** Verify no TypeScript errors in file
- [ ] **3.12** Test compile: `pnpm build` or `pnpm dev`

### Phase 4: Code Cleanup

- [x] **4.1** Remove any unused imports
- [x] **4.2** Remove commented-out v2.0 code
- [x] **4.3** Search for "payload" and ensure all changed to "data"
- [x] **4.4** Search for "status_update" and ensure all changed to "progress_update"
- [x] **4.5** Search for "currentStatus" and ensure all changed to "currentProgress"
- [x] **4.6** Search for "presentationId" and ensure all removed
- [ ] **4.7** Run linter: `pnpm lint`
- [ ] **4.8** Fix any linting errors

### Phase 5: Build Verification

- [ ] **5.1** Run TypeScript compiler: `pnpm build`
- [ ] **5.2** Verify build succeeds with no errors
- [ ] **5.3** Check for warnings and address if critical
- [ ] **5.4** Start dev server: `pnpm dev`
- [ ] **5.5** Verify no console errors on page load

**Note**: Dependencies need to be installed first:
```bash
pnpm install
# Then run:
pnpm build
# Or start dev server:
pnpm dev
```

---

## Manual Testing Plan

### Test Environment Setup

**Prerequisites:**
- [ ] Dev server running: `pnpm dev`
- [ ] Browser: Chrome/Firefox with DevTools open
- [ ] Network tab visible for WebSocket monitoring
- [ ] Console tab visible for error monitoring
- [ ] Director v3.4 backend is running and accessible

---

### Test Suite 1: WebSocket Connection

**Objective**: Verify WebSocket connects to v3.4 endpoint

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 1.1 | Open browser to http://localhost:3000/builder | Page loads without errors | [ ] |
| 1.2 | Check Network tab ‚Üí WS | WebSocket connection to `directorv33-production.up.railway.app` | [ ] |
| 1.3 | Check Console | See "‚úÖ Connected to Director Agent" log | [ ] |
| 1.4 | Check UI | Connection badge shows "Connected" | [ ] |

**If Failed:**
- Check WebSocket URL in `use-deckster-websocket-v2.ts`
- Verify Director v3.4 backend is running
- Check network connectivity

---

### Test Suite 2: Initial Greeting (Stage 1)

**Objective**: Verify chat_message displays correctly

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 2.1 | Wait after connection | Greeting message appears in chat | [ ] |
| 2.2 | Check message content | Message displays: "Hello! I'll help you create..." or similar | [ ] |
| 2.3 | Check message styling | Message has bot icon, gray background, left-aligned | [ ] |
| 2.4 | Check console | No errors in console | [ ] |

**Sample Message:**
```json
{
  "type": "chat_message",
  "data": {
    "text": "Hello! I'll help you create a presentation. What topic would you like to present?",
    "format": "text"
  }
}
```

**If Failed:**
- Check chat_message rendering code
- Verify `data.text` is being accessed (not `payload.text`)
- Check message is added to messages array

---

### Test Suite 3: User Message Sending

**Objective**: Verify user can send messages

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 3.1 | Type "AI in healthcare" in chat input | Text appears in input field | [ ] |
| 3.2 | Press Enter or click Send | Message sent to server | [ ] |
| 3.3 | Check UI | User message appears in chat (blue, right-aligned) | [ ] |
| 3.4 | Check Network ‚Üí WS | Message sent: `{"type":"user_message","data":{"text":"AI in healthcare"}}` | [ ] |
| 3.5 | Wait for response | Director responds with follow-up question | [ ] |

**If Failed:**
- Check sendMessage function
- Verify message format is correct
- Check WebSocket connection is still open

---

### Test Suite 4: Clarifying Questions (Stage 2)

**Objective**: Verify multi-turn conversation works

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 4.1 | Wait for Director question | Question appears: "What's the target audience?" or similar | [ ] |
| 4.2 | Type answer: "Healthcare professionals" | User message displays | [ ] |
| 4.3 | Send message | Director asks next question | [ ] |
| 4.4 | Continue answering | Conversation continues smoothly | [ ] |
| 4.5 | Check message order | All messages in chronological order | [ ] |

**If Failed:**
- Check message sorting logic
- Verify clientTimestamp is being added
- Check messages array updates correctly

---

### Test Suite 5: Action Buttons (Stage 3)

**Objective**: Verify action_request displays and works

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 5.1 | Wait for action request | Prompt displays: "Should I proceed with this plan?" | [ ] |
| 5.2 | Check buttons | Two buttons: "Accept" (primary, blue) and "Revise" (outline) | [ ] |
| 5.3 | Click "Accept" button | Button action sent as user message | [ ] |
| 5.4 | Check UI | "Accept" appears as user message | [ ] |
| 5.5 | Check workflow | Director proceeds to next stage | [ ] |

**Sample Message:**
```json
{
  "type": "action_request",
  "data": {
    "prompt_text": "Here's your presentation plan. Should I proceed?",
    "actions": [
      {"label": "Accept", "value": "accept", "primary": true},
      {"label": "Revise", "value": "revise", "primary": false}
    ]
  }
}
```

**If Failed:**
- Check action_request rendering
- Verify buttons render from `data.actions` (not `payload.actions`)
- Check handleActionClick function

---

### Test Suite 6: Slide Structure Preview

**Objective**: Verify slide_update displays presentation outline

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 6.1 | Wait for slide_update | Outline displays in chat with blue background | [ ] |
| 6.2 | Check metadata | Title, slide count, duration shown | [ ] |
| 6.3 | Check slide list | All slides listed with numbers and titles | [ ] |
| 6.4 | Check styling | Blue border, proper formatting | [ ] |
| 6.5 | Check scrolling | If many slides, list is scrollable | [ ] |

**Sample Message:**
```json
{
  "type": "slide_update",
  "data": {
    "metadata": {
      "title": "AI in Healthcare",
      "total_slides": 10,
      "theme": "professional",
      "duration_minutes": 15
    },
    "slides": [
      {"slide_number": 1, "title": "Title Slide", "classification": "title_slide", ...},
      {"slide_number": 2, "title": "Introduction", "classification": "text_content", ...}
    ]
  }
}
```

**If Failed:**
- Check slide_update rendering code was added
- Verify data structure access
- Check styling classes applied

---

### Test Suite 7: Progress Updates (Stage 6)

**Objective**: Verify progress_update shows generation progress

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 7.1 | Wait for content generation to start | Progress indicator appears in status bar | [ ] |
| 7.2 | Check progress message | Message shows: "Generating slide X of Y..." | [ ] |
| 7.3 | Check progress bar | Progress bar fills from 0% to 100% | [ ] |
| 7.4 | Check slide numbers | Current slide and total displayed | [ ] |
| 7.5 | Watch updates | Progress updates smoothly as slides generate | [ ] |
| 7.6 | Check in chat | Progress messages also appear in chat area | [ ] |

**Sample Message:**
```json
{
  "type": "progress_update",
  "data": {
    "stage": "content_generation",
    "message": "Generating slide 5 of 10: Four Pillars of Excellence",
    "current_slide": 5,
    "total_slides": 10,
    "percentage": 50
  }
}
```

**If Failed:**
- Check progress_update rendering in both status bar and chat
- Verify `data.message`, `data.percentage`, `data.current_slide` accessed
- Check Progress component receives correct value

---

### Test Suite 8: Presentation URL (Final)

**Objective**: Verify presentation loads in iframe

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 8.1 | Wait for generation to complete | Success message appears in chat | [ ] |
| 8.2 | Check success stats | Shows "X of Y slides generated successfully" | [ ] |
| 8.3 | Check for failures | If any failures, warning shown | [ ] |
| 8.4 | Check right panel | Presentation loads in iframe (right 75% of screen) | [ ] |
| 8.5 | Verify URL | Presentation displays correctly | [ ] |
| 8.6 | Test "Open in new tab" | Button opens presentation in new window | [ ] |

**Sample Message (Success):**
```json
{
  "type": "presentation_url",
  "data": {
    "url": "http://localhost:8504/p/abc-123",
    "slide_count": 10,
    "content_generated": true,
    "successful_slides": 10,
    "failed_slides": 0,
    "message": "Your presentation is ready!"
  }
}
```

**Sample Message (Partial Failure):**
```json
{
  "type": "presentation_url",
  "data": {
    "url": "http://localhost:8504/p/abc-123",
    "slide_count": 10,
    "successful_slides": 8,
    "failed_slides": 2,
    "message": "Your presentation is ready with some issues."
  }
}
```

**If Failed:**
- Check presentation_url rendering
- Verify iframe src is set correctly
- Check success/failure stats display
- Verify conditional styling (green for success, orange for warnings)

---

### Test Suite 9: Error Handling

**Objective**: Verify error messages display correctly

**Test 9.1: Recoverable Error**

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 9.1 | Trigger error (e.g., service unavailable) | Error message appears with red styling | [ ] |
| 9.2 | Check error details | Error message and details displayed | [ ] |
| 9.3 | Check recoverable flag | If recoverable, shows "You can try again" message | [ ] |

**Sample Message:**
```json
{
  "type": "error",
  "data": {
    "error": "Text Service unavailable",
    "details": "Failed to connect to content generation service",
    "recoverable": true
  }
}
```

**If Failed:**
- Check error message rendering was added
- Verify red styling applied
- Check recoverable message displays

---

### Test Suite 10: Edge Cases

**Test 10.1: Very Long Messages**

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 10.1 | Type very long message (500+ chars) | Message sends successfully | [ ] |
| 10.2 | Check display | Message wraps correctly, scrollable | [ ] |

**Test 10.2: Special Characters**

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 10.2.1 | Send message with emojis: "AI ü§ñ presentation" | Displays correctly | [ ] |
| 10.2.2 | Send message with quotes: `He said "AI is great"` | Displays correctly | [ ] |

**Test 10.3: Rapid Messages**

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 10.3.1 | Send multiple messages quickly | All messages sent | [ ] |
| 10.3.2 | Check order | Messages in correct chronological order | [ ] |

**Test 10.4: Connection Drop**

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 10.4.1 | Stop Director backend server | Connection status shows "Disconnected" | [ ] |
| 10.4.2 | Try to send message | Error shown: "Not connected" | [ ] |
| 10.4.3 | Restart backend | Connection re-establishes (or shows reconnect option) | [ ] |

---

### Test Suite 11: Browser Compatibility

**Test on Multiple Browsers:**

| Browser | Version | Connection Works | Messages Display | Iframe Loads | Status |
|---------|---------|------------------|------------------|--------------|--------|
| Chrome | Latest | [ ] | [ ] | [ ] | [ ] |
| Firefox | Latest | [ ] | [ ] | [ ] | [ ] |
| Safari | Latest | [ ] | [ ] | [ ] | [ ] |
| Edge | Latest | [ ] | [ ] | [ ] | [ ] |

---

### Test Suite 12: Performance

**Test 12.1: Large Presentations**

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 12.1 | Request 20-slide presentation | Handles smoothly | [ ] |
| 12.2 | Watch progress updates | Updates don't cause lag | [ ] |
| 12.3 | Check memory | No memory leaks (DevTools ‚Üí Memory) | [ ] |

**Test 12.2: Long Sessions**

| Step | Action | Expected Result | Status |
|------|--------|-----------------|--------|
| 12.2.1 | Create multiple presentations in one session | Each works correctly | [ ] |
| 12.2.2 | Check message history | Old messages don't cause slowdown | [ ] |

---

### Test Results Summary

**Date Tested**: ________________
**Tested By**: ________________

**Overall Results:**
- Total Tests: 12 suites, ~60 test steps
- Passed: _____ / _____
- Failed: _____ / _____
- Skipped: _____ / _____

**Critical Issues Found:**
1. ________________________________
2. ________________________________
3. ________________________________

**Non-Critical Issues:**
1. ________________________________
2. ________________________________

**Notes:**
_______________________________________________
_______________________________________________
_______________________________________________

---

## Rollback Plan

### When to Rollback

Rollback if any of the following occur:
- WebSocket connection fails completely
- Critical rendering errors prevent app from loading
- Data loss or corruption occurs
- More than 3 critical bugs found in testing
- Migration exceeds allocated time significantly

### Rollback Steps

#### Quick Rollback (Git-based)

If you created a backup branch:

```bash
# 1. Stash or discard current changes
git stash

# 2. Switch to backup branch
git checkout backup-pre-v3.4-migration

# 3. Verify app works
pnpm dev

# 4. If needed, create new branch from backup
git checkout -b rollback-v3.4-migration
```

#### Manual Rollback

If no backup branch exists:

1. **Restore from Git History**
   ```bash
   # Find the last working commit before migration
   git log --oneline

   # Reset to that commit
   git reset --hard <commit-hash>
   ```

2. **Revert Specific Files**
   ```bash
   # Revert individual files
   git checkout HEAD~1 hooks/use-deckster-websocket-v2.ts
   git checkout HEAD~1 app/builder/page.tsx
   ```

3. **Test Rollback**
   ```bash
   pnpm dev
   # Verify app works with v2.0
   ```

### Post-Rollback Actions

- [ ] Document what went wrong
- [ ] Create bug report with error logs
- [ ] Review migration plan for issues
- [ ] Schedule retry with fixes
- [ ] Notify team of rollback

---

## Post-Migration Validation

### Functionality Checklist

After migration is complete, verify:

**Core Functionality:**
- [ ] WebSocket connects successfully
- [ ] Messages send and receive correctly
- [ ] All message types render properly
- [ ] Action buttons work
- [ ] Progress tracking displays
- [ ] Presentations load in iframe
- [ ] Error messages display

**User Experience:**
- [ ] No visible bugs in UI
- [ ] Smooth message rendering
- [ ] Responsive layout maintained
- [ ] Loading states work
- [ ] No console errors
- [ ] No TypeScript errors

**Performance:**
- [ ] Page loads quickly (<2s)
- [ ] Messages render instantly
- [ ] No memory leaks
- [ ] Smooth scrolling
- [ ] Progress updates don't lag

**Cross-Browser:**
- [ ] Works in Chrome
- [ ] Works in Firefox
- [ ] Works in Safari
- [ ] Works in Edge

### Performance Benchmarks

Compare before and after migration:

| Metric | Before (v2.0) | After (v3.4) | Status |
|--------|---------------|--------------|--------|
| Initial page load | _____ ms | _____ ms | [ ] |
| Time to WebSocket connect | _____ ms | _____ ms | [ ] |
| Message render time | _____ ms | _____ ms | [ ] |
| Memory usage (idle) | _____ MB | _____ MB | [ ] |
| Memory usage (active) | _____ MB | _____ MB | [ ] |

### Regression Testing

Test features that should NOT have changed:

- [ ] Landing page loads correctly
- [ ] Dashboard page works
- [ ] Authentication flow works
- [ ] Settings page accessible
- [ ] Profile page accessible
- [ ] Navigation between pages
- [ ] Theme switching (if applicable)

### Production Readiness

Before deploying to production:

- [ ] All tests passed
- [ ] No critical bugs
- [ ] Performance acceptable
- [ ] Code reviewed
- [ ] Documentation updated
- [ ] Changelog created
- [ ] Deployment plan ready
- [ ] Rollback plan accessible

---

## Timeline & Dependencies

### Task Breakdown

| Task | Duration | Dependencies | Risk |
|------|----------|--------------|------|
| **1. Pre-Migration** | 30 min | None | Low |
| 1.1 Backup code | 5 min | None | Low |
| 1.2 Review docs | 15 min | None | Low |
| 1.3 Setup environment | 10 min | None | Low |
| **2. Type Updates** | 1-2 hours | Task 1 | Medium |
| 2.1 Update interfaces | 45-60 min | None | Medium |
| 2.2 Update union types | 15 min | 2.1 | Low |
| 2.3 Fix TypeScript errors | 30-45 min | 2.1, 2.2 | High |
| **3. Hook Logic** | 1 hour | Task 2 | Medium |
| 3.1 Update state management | 20 min | 2.1 | Medium |
| 3.2 Update message handlers | 30 min | 2.1 | High |
| 3.3 Add client timestamps | 10 min | None | Low |
| **4. UI Updates** | 1-2 hours | Task 2, 3 | Medium |
| 4.1 Update imports | 5 min | 2.1 | Low |
| 4.2 Update component state | 10 min | 3.1 | Low |
| 4.3 Update message rendering | 60-90 min | 2.1, 3.2 | High |
| 4.4 Add new message types | 30 min | 2.1 | Medium |
| **5. Testing** | 1-2 hours | Task 4 | High |
| 5.1 Manual testing | 60-90 min | All | High |
| 5.2 Bug fixes | 30-60 min | 5.1 | High |
| **6. Cleanup** | 30 min | Task 5 | Low |
| 6.1 Remove old code | 10 min | 5.1 | Low |
| 6.2 Linting | 10 min | All | Low |
| 6.3 Final build test | 10 min | All | Medium |

### Critical Path

```
Pre-Migration (30m)
    ‚Üì
Type Updates (1-2h)  ‚Üê CRITICAL
    ‚Üì
Hook Logic (1h)      ‚Üê CRITICAL
    ‚Üì
UI Updates (1-2h)    ‚Üê CRITICAL
    ‚Üì
Testing (1-2h)       ‚Üê CRITICAL
    ‚Üì
Cleanup (30m)
```

**Total Estimated Time**: 3-6 hours

### Parallel Tasks

These tasks can be done in parallel if multiple developers:
- Type interface updates (2.1)
- State management updates (3.1)
- Documentation review (1.2) during other tasks

### Blocker Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| TypeScript errors hard to resolve | Medium | High | Have TypeScript expert available |
| Backend v3.4 not ready | Low | Critical | Verify backend status before starting |
| New message types not documented | Low | Medium | Refer to integration guide |
| Breaking UI changes | Low | Medium | Test frequently during development |

---

## Appendix

### A. Quick Reference: v2.0 vs v3.4

#### Message Structure
| Aspect | v2.0 | v3.4 |
|--------|------|------|
| Envelope | `{message_id, session_id, timestamp, type, payload}` | `{type, data}` |
| Data field | `payload` | `data` |
| Message ID | From server | Client-side if needed |
| Timestamp | From server | Client-side if needed |

#### Message Types
| v2.0 | v3.4 | Status |
|------|------|--------|
| `chat_message` | `chat_message` | Modified |
| `action_request` | `action_request` | Modified |
| `status_update` | `progress_update` | Renamed & redesigned |
| `presentation_url` | `presentation_url` | Enhanced |
| `state_change` | ‚Äî | Removed |
| ‚Äî | `slide_update` | New |
| ‚Äî | `error` | New |

#### Field Changes
| Message Type | v2.0 Field | v3.4 Field | Change |
|--------------|------------|------------|--------|
| All | `payload` | `data` | Renamed |
| `chat_message` | `sub_title` | ‚Äî | Removed |
| `chat_message` | `list_items` | ‚Äî | Removed |
| `chat_message` | `format: 'plain'` | `format: 'text'` | Renamed |
| `action_request` | `requires_input` | ‚Äî | Removed |
| `status_update` | `text` | `message` | Renamed (in progress_update) |
| `status_update` | `progress` | `percentage` | Renamed (in progress_update) |
| `progress_update` | ‚Äî | `current_slide` | New |
| `progress_update` | ‚Äî | `total_slides` | New |
| `progress_update` | ‚Äî | `stage` | New |
| `presentation_url` | `presentation_id` | ‚Äî | Removed |
| `presentation_url` | ‚Äî | `successful_slides` | New |
| `presentation_url` | ‚Äî | `failed_slides` | New |
| `presentation_url` | ‚Äî | `content_generated` | New |

### B. Common Migration Issues

**Issue**: TypeScript error: "Property 'payload' does not exist"
**Solution**: Change `payload` to `data` throughout

**Issue**: Messages not rendering
**Solution**: Check message type in switch statement matches new types

**Issue**: Progress bar not updating
**Solution**: Ensure using `currentProgress.percentage` (not `currentStatus.progress`)

**Issue**: Presentation iframe not loading
**Solution**: Verify `presentationUrl` is being set from `data.url` (not `payload.url`)

**Issue**: Messages out of order
**Solution**: Ensure `clientTimestamp` is being added in message handler

**Issue**: Action buttons not working
**Solution**: Check accessing `data.actions` (not `payload.actions`)

### C. Useful Commands

```bash
# Check for old field names
grep -r "payload\." hooks/ app/

# Check for old type names
grep -r "StatusUpdate" hooks/ app/

# Check for old state fields
grep -r "currentStatus" app/

# Find all message_id references
grep -r "message_id" hooks/ app/

# Run TypeScript check
pnpm tsc --noEmit

# Run build
pnpm build

# Run dev server
pnpm dev

# Run linter
pnpm lint
```

### D. Contact & Support

**Migration Lead**: [Your Name]
**Backend Team**: Director v3.4 developers
**Frontend Team**: Deckster frontend developers

**Resources:**
- Director v3.4 Integration Guide: `docs/FRONTEND_INTEGRATION_GUIDE_v3.4.md`
- This Migration Plan: `docs/plan/V3.4_MIGRATION_PLAN.md`
- GitHub Issues: [Repository URL]

### E. Success Metrics

**Definition of Success:**
- [ ] WebSocket connects to v3.4 successfully
- [ ] All 6 message types work correctly
- [ ] Complete presentation flow works end-to-end
- [ ] No TypeScript or console errors
- [ ] All manual tests pass
- [ ] Performance is equal or better than v2.0
- [ ] Code is clean and maintainable

**Sign-off:**

- [ ] Developer: _________________ Date: _______
- [ ] Code Reviewer: _________________ Date: _______
- [ ] QA Tester: _________________ Date: _______
- [ ] Product Owner: _________________ Date: _______

---

## Document Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-01-05 | Migration Team | Initial migration plan created |

---

**End of Migration Plan**

This document should be used as the single source of truth for the v3.4 migration. All team members should review and reference this document throughout the migration process.
